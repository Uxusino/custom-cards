<!DOCTYPE html>
<html>
<head>
  {% if not pack or (userid != session["userid"] and pack['is_public'] == False) %}
    <title>Pack â„–404</title>
  {% else %}
    <title>{{ pack['name'] }}</title>
  {% endif %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    function editName(nameDisplay, nameInput) {
        nameDisplay.style.display = "none";
        nameInput.style.display = "inline";
        nameInput.value = nameDisplay.textContent;
        nameInput.focus();
    }
    function saveName(event, nameDisplay, nameInput, url, cardId = null) {
        if (event.key === "Enter") {
            nameDisplay.textContent = nameInput.value;
            nameDisplay.style.display = "inline";
            nameInput.style.display = "none";
            $.ajax({
                url: url,
                type: "POST",
                data: {
                    name: nameInput.value,
                    id: "{{ pack['id'] }}",
                    cardId: cardId,
                    crsf_token: "{{ session.crsf_token }}"
                },
                success: function() {
                    console.log("Name edited successfully.");
                },
                error: function() {
                    console.log("Error!")
                }
            });
        }
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("changeLanguage").onclick = function() {
            document.getElementById("modal-languages").style.display = "block";
        };

        document.getElementById("closeModal").onclick = function() {
            document.getElementById("modal-languages").style.display = "none";
        };

        window.onclick = function(event) {
            if (event.target == document.getElementById("modal-languages")) {
                document.getElementById("modal-languages").style.display = "none";
            }
        };
    }); 
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        var languages = {{ languages|tojson }};
        function updateLanguageList(filter) {
            var languageList = document.getElementById("languageList");
            languageList.innerHTML = '';
            languages.forEach(function(language) {
                if (!filter || language.toLowerCase().includes(filter.toLowerCase())) {
                    var languageItem = document.createElement("div");
                    languageItem.textContent = language;
                    languageItem.classList.add("language-item");
                    languageItem.onclick = function() {
                        document.getElementById("modal-languages").style.display = "none";
                        $.ajax({
                            url: "/edit_language",
                            type: "POST",
                            data: {
                                language: language,
                                id: "{{ pack['id'] }}",
                                crsf_token: "{{ session.crsf_token }}"
                            },
                            success: function() {
                                console.log("Language edited successfully!")
                            },
                            error: function() {
                                console.log("There was an error while editing language.")
                            }
                        });
                    };
                    languageList.appendChild(languageItem);
                }
            });
        }
        document.getElementById("languageSearch").addEventListener("input", function(event) {
            updateLanguageList(event.target.value);
        });
        document.getElementById("changeLanguage").addEventListener("click", function() {
           updateLanguageList(''); 
        });
    });
  </script>
</head>
<body>
    {% if not pack %}
        <p>This pack doesn't exist.</p>
    {% elif userid != session["userid"] and pack['is_public'] == False %}
        <p>This pack is set as private.</p>
    {% else %}
        <span id="nameDisplay">{{ pack['name'] }}</span>

        {% if userid == session["userid"] %}
            <input type="text" id="nameInput" style="display:none" onkeydown="saveName(event, nameDisplay, nameInput, '/edit_name')">
            <button id="editNameButton" onclick="editName(nameDisplay, nameInput)">Edit</button>
        {% endif %}

        <br>
        <i>{{ pack['author'] }}</i>
        <p>Language: {{ pack['language'] }}</p>

        {% if userid == session["userid"] %}
            <button id="changeLanguage">Change language</button>
            <div id="modal-languages" class="modal">
                <div class="modal-content">
                    <span id="closeModal">&times;</span>
                    <input type="text" id="languageSearch" placeholder="Search for a language...">
                    <div id="languageList" class="language-list"></div>
                </div>
            </div>
        {% endif %}

        {% if pack['is_public'] == True %}
            <p>This is a public pack.</p>
            {% if userid == session["userid"] %}
                <form method="POST" action="/edit_privacy">
                    <input type="hidden" name="privacy" value="false">
                    <input type="hidden" name="id" value="{{ pack['id'] }}">
                    <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                    <button type="submit">Make private</button>
                    <br>
                </form>
            {% endif %}
        {% else %}
            <p>This is a private pack.</p>
            {% if userid == session["userid"] %}
                <form method="POST" action="/edit_privacy">
                    <input type="hidden" name="privacy" value="true">
                    <input type="hidden" name="id" value="{{ pack['id'] }}">
                    <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                    <button type="submit">Make public</button>
                    <br>
                </form>
            {% endif %}
        {% endif %}
        <br>
        {% if userid == session["userid"] %}
            <form method="POST" action="/delete_pack">
                <input type="hidden" name="id" value="{{ pack['id'] }}">
                <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                <button type="submit">Delete pack</button>
            </form>
        {% endif %}
        {% block content %}
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for msg in messages %}
                        <p>{{msg}}</p>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        {% endblock %}
        <div class="cards-block" id="white-cards">
            <p>White cards:</p>
            {% if userid == session["userid"] %}
                <form method="POST" action="/add_white_card">
                    <input type="text" name="white_card_content" placeholder="Add new white card..." required>
                    <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                    <input type="hidden" name="pack_id" value="{{ pack['id'] }}">
                    <button type="submit">Add</button>
                </form>
                
            {% endif %}
            {% if white_cards %}
                {% for white_card in white_cards %}
                    <div class="card" id="white-card">
                        <a class="card-name" id="whiteCardDisplay{{ white_card['id'] }}">{{ white_card['content'] }}</a>
                        <input 
                            type="text" 
                            id="whiteCardInput{{ white_card['id'] }}" 
                            style="display:none" 
                            onkeydown="saveName(event, whiteCardDisplay{{ white_card['id'] }}, whiteCardInput{{ white_card['id'] }}, '/edit_white_card', {{ white_card['id'] }})" required>
                        <button type="button" onclick="editName(whiteCardDisplay{{ white_card['id'] }}, whiteCardInput{{ white_card['id'] }})">Edit</button>

                        <form method="POST" action="/delete_white_card">
                            <input type="hidden" name="white_card_id" value="{{ white_card['id'] }}">
                            <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                            <input type="hidden" name="pack_id" value="{{ pack['id'] }}">
                            <button type="submit">Delete</button>
                        </form>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        <div class="cards-block" id="black-cards">
            <p>Black cards:</p>
            {% if userid == session["userid"] %}
                <form method="POST" action="/add_black_card">
                    <input type="text" name="black_card_content" placeholder="Add new black card..." required>
                    <input type="hidden" name="pack_id" value="{{ pack['id'] }}">
                    <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                    <button type="submit">Add</button>
                </form>
            {% endif %}
            {% if black_cards %}
                {% for black_card in black_cards %}
                    <div class="card" id="black-card">
                        <a class="card-name" id="blackCardDisplay{{ black_card['id'] }}">{{ black_card['content'] }}</a>
                        <input
                            type="text" 
                            id="blackCardInput{{ black_card['id'] }}" 
                            style="display:none" 
                            onkeydown="saveName(event, blackCardDisplay{{ black_card['id'] }}, blackCardInput{{ black_card['id'] }}, '/edit_black_card', {{ black_card['id'] }})" required>
                        <button type="button" onclick="editName(blackCardDisplay{{ black_card['id'] }}, blackCardInput{{ black_card['id'] }})">Edit</button>
                        <form method="POST" action="/delete_black_card">
                            <input type="hidden" name="black_card_id" value="{{ black_card['id'] }}">
                            <input type="hidden" name="crsf_token" value="{{ session.crsf_token }}">
                            <input type="hidden" name="pack_id" value="{{ pack['id'] }}">
                            <button type="submit">Delete</button>
                        </form>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

    {% endif %}
    <div class="menu">
        {% if not is_guest %}
            <a href="/users/{{ session.username }}">My packs</a>
            <br>
            <a href="/search">Search</a>
            <br>
            <a href="/logout">Log out</a>
        {% else %}
            <a href="/register">Sign up</a>
            <br>
            <a href="/search">Search</a>
        {% endif %}
        <br>
        <a href="/">Main page</a>
    </div>
</body>
</html>